

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced managment &mdash; qjazz ${PIN_VERSION} documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=e556e3f7"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Managment API" href="managment-api.html" />
    <link rel="prev" title="HTTP frontend" href="server_config.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            qjazz
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html#quick-setup">Quick setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html#configuration-setup">Configuration setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpc_config.html">QGIS RPC services</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpc_config.html#qgis-project-s-cache-overview">Qgis project’s cache overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="server_config.html">HTTP frontend</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced managment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#running-managment-from-cli">Running managment from CLI</a></li>
<li class="toctree-l2"><a class="reference internal" href="#managment-from-rest-api">Managment from REST api</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api-specification">Api specification</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-schema">Configuration schema</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#case-scenarios">Case scenarios</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#synchronizing-pool-cache">Synchronizing pool cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-modifying-or-removing-pool-to-managment-service">Adding, modifying or removing pool to managment service</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resyncing-with-rpc-pools-when-rescaling-rpc-services">Resyncing with rpc pools when rescaling rpc services</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="managment-api.html">Managment API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">qjazz</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Advanced managment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/managment.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-managment">
<span id="adv-managment"></span><h1>Advanced managment<a class="headerlink" href="#advanced-managment" title="Link to this heading"></a></h1>
<p><cite>qjazz</cite> come with managment tools for Qgis service clusters.</p>
<p>It allows you to:</p>
<ul class="simple">
<li><p>Retrieve infos about running Qgis clusters</p></li>
<li><p>Synchronize cache between instances of the same Qgis pools</p></li>
<li><p>Manage cache for each instances.</p></li>
<li><p>Get plugin’s infos</p></li>
<li><p>List project’s catalog</p></li>
<li><p>Watch health status</p></li>
<li><p>Serve REST managment api</p></li>
</ul>
<section id="running-managment-from-cli">
<h2>Running managment from CLI<a class="headerlink" href="#running-managment-from-cli" title="Link to this heading"></a></h2>
<p>You may run the managment tool from CLI:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; pip install qjazz-admin
&gt; python3 -m qjazz_admin --help
Usage: python -m qjazz_admin [OPTIONS] COMMAND [ARGS]...

Options:
  --help  Show this message and exit.

Commands:
  cache    Cache management
  catalog  Print catalog for &#39;host&#39;
  conf     Configuration management
  doc      Manage documentation
  plugins  List backend&#39;s loaded plugins
  pools    List all pools
  serve    Run admin server
  stats    Output qgis gRPC services stats
  watch    Watch a cluster of qgis gRPC services
</pre></div>
</div>
<p>or from the docker image:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>docker run -it --rm  -v &lt;path/to/configfile&gt;:/etc/qjazz-server-admin.toml \
    -e PY_QGIS_SERVER_ADMIN_CONFIGFILE=/etc/qjazz-server-admin.toml \
    3liz/qjazz:ltr qjazz-server-admin
</pre></div>
</div>
</section>
<section id="managment-from-rest-api">
<h2>Managment from REST api<a class="headerlink" href="#managment-from-rest-api" title="Link to this heading"></a></h2>
<p>Managment may also be handler using REST api with the <cite>serve</cite> command:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; qjazz-server-admin serve
</pre></div>
</div>
<p>From this you can use your own dashboard for managing your Qgis clusters.</p>
<section id="api-specification">
<h3>Api specification<a class="headerlink" href="#api-specification" title="Link to this heading"></a></h3>
<p>See the <a class="reference internal" href="managment-api.html"><span class="doc">Managment API</span></a>
or download the <a class="reference download internal" download="" href="_downloads/71fdc0b8c9fc3a2fb391879da711b477/openapi-managment.json"><code class="xref download docutils literal notranslate"><span class="pre">Json</span> <span class="pre">specs</span></code></a>.</p>
</section>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h2>
<p>Configuration is read from toml file or from remote http url.</p>
<p>The configuration define Qgis backend’s pool with <cite>resolvers</cite> that describe
how to access the pools - actually only DNS résolution and unix socket are
supported.</p>
<p>The following example define the <cite>qgis-rpc</cite> host as a DNS endpoint for a cluster
of qgis services pool.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[resolvers]</span>

<span class="k">[[resolvers.pools]]</span>
<span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;basic&quot;</span>
<span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dns&quot;</span>
<span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;qgis-rpc&quot;</span>
<span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">23456</span>
</pre></div>
</div>
<p>If you are using the <a class="reference internal" href="intro.html#docker-compose-setup"><span class="std std-ref">basic docker-compose example</span></a> and your
running admin container is attached to the compose network stack, then your configuration
will point to the <cite>qgis-rpc</cite> services.</p>
<p>Examples:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; qjazz-server-admin pools
Pool  1. basic           qgis-rpc:23456    backends: 3
* 172.25.0.5:23456
* 172.25.0.2:23456
* 172.25.0.6:23456

&gt; qjazz-server-admin stats --host qgis-rpc
[
    {
        &quot;address&quot;: &quot;172.25.0.2:23456&quot;,
        &quot;numWorkers&quot;: 1,
        &quot;requestPressure&quot;: 0.0,
        &quot;status&quot;: &quot;ok&quot;,
        &quot;stoppedWorkers&quot;: 0,
        &quot;uptime&quot;: 6217,
        &quot;workerFailurePressure&quot;: 0.0
    },
    {
        &quot;address&quot;: &quot;172.25.0.5:23456&quot;,
        &quot;numWorkers&quot;: 1,
        &quot;requestPressure&quot;: 0.0,
        &quot;status&quot;: &quot;ok&quot;,
        &quot;stoppedWorkers&quot;: 0,
        &quot;uptime&quot;: 132,
        &quot;workerFailurePressure&quot;: 0.0
    },
    {
        &quot;address&quot;: &quot;172.25.0.6:23456&quot;,
        &quot;numWorkers&quot;: 1,
        &quot;requestPressure&quot;: 0.0,
        &quot;status&quot;: &quot;ok&quot;,
        &quot;stoppedWorkers&quot;: 0,
        &quot;uptime&quot;: 131,
        &quot;workerFailurePressure&quot;: 0.0
    }
]
</pre></div>
</div>
</section>
<section id="configuration-schema">
<span id="admin-configuration-schema"></span><h2>Configuration schema<a class="headerlink" href="#configuration-schema" title="Link to this heading"></a></h2>
<p>When reading configuration from file, the format is TOML
by default.</p>
<p>The configuration schema may be output as different format using the <cite>doc</cite> command
from the CLI: the <cite>json</cite> or <cite>yaml</cite> format may be used for validation.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[logging]</span>
<span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span>


<span class="k">[admin_http]</span>
<span class="c1">#</span>
<span class="c1"># Interfaces to listen to</span>
<span class="n">listen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="mi">9871</span><span class="p">]</span>
<span class="c1">#</span>
<span class="c1"># Use ssl</span>
<span class="n">use_ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="c1">#</span>
<span class="c1"># CORS origin</span>
<span class="c1">#</span>
<span class="c1"># Allows to specify origin for CORS. If set &#39;all&#39; will set</span>
<span class="c1"># Access-Control-Allow-Origin to &#39;*&#39;; &#39;same-origin&#39; return</span>
<span class="c1"># the same value as the &#39;Origin&#39; request header.</span>
<span class="c1"># An url may may be specified, restricting allowed origin to this url.</span>
<span class="n">cross_origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;all&quot;</span>
<span class="c1">#</span>
<span class="c1"># Enable proxy_configuration</span>
<span class="c1">#</span>
<span class="c1"># Indicates that the server is behind a reverse proxy.</span>
<span class="c1"># This enable handling of forwarded proxy headers</span>
<span class="n">proxy_conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="c1">#</span>
<span class="c1"># List of authorized tokens</span>
<span class="n">auth_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="c1">#</span>
<span class="c1"># TLS certificats</span>
<span class="c1">#</span>
<span class="k">[admin_http.ssl]</span>
<span class="c1">#</span>
<span class="c1"># CA file</span>
<span class="c1">#cafile =   	# Optional</span>
<span class="c1">#</span>
<span class="c1"># TLS  certificat</span>
<span class="c1">#</span>
<span class="c1"># Path to the TLS cert file</span>
<span class="c1">#certfile =   	# Optional</span>
<span class="c1">#</span>
<span class="c1"># TLS key file</span>
<span class="c1">#</span>
<span class="c1"># Path to the TLS key file</span>
<span class="c1">#keyfile =   	# Optional</span>


<span class="c1"># Remote configuration settings</span>
<span class="k">[admin_config_url]</span>
<span class="c1">#</span>
<span class="c1"># External configuration Url</span>
<span class="c1">#</span>
<span class="c1"># The server will issue a GET method against this url at startup.</span>
<span class="c1"># The method should returns a valid configuration fragment.</span>
<span class="c1"># Note that this overrides all local settings.</span>
<span class="c1">#url =   	# Optional</span>

<span class="c1">#</span>
<span class="c1"># TLS configuration</span>
<span class="c1">#</span>
<span class="k">[admin_config_url.ssl]</span>
<span class="c1">#</span>
<span class="c1"># CA file</span>
<span class="c1">#cafile =   	# Optional</span>
<span class="c1">#</span>
<span class="c1"># TLS  certificat</span>
<span class="c1">#</span>
<span class="c1"># Path to the TLS cert file</span>
<span class="c1">#certfile =   	# Optional</span>
<span class="c1">#</span>
<span class="c1"># TLS key file</span>
<span class="c1">#</span>
<span class="c1"># Path to the TLS key file</span>
<span class="c1">#keyfile =   	# Optional</span>


<span class="k">[resolvers]</span>

<span class="c1">#</span>
<span class="c1"># List of Rpc backends</span>
<span class="c1">#</span>
<span class="k">[[resolvers.resolvers]]</span>
<span class="c1">#</span>
<span class="c1"># Unique label</span>
<span class="c1">#</span>
<span class="c1"># Unique resolver label. The label must be compatible with an url path component.</span>
<span class="c1">#label =   	# Required</span>
<span class="c1">#</span>
<span class="c1"># RPC address</span>
<span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;::1&quot;</span><span class="p">,</span><span class="mi">23456</span><span class="p">]</span>
<span class="c1">#</span>
<span class="c1"># Check for ipv6</span>
<span class="n">ipv6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="c1">#</span>
<span class="c1"># Use ssl connection</span>
<span class="n">use_ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="c1">#description =   	# Optional</span>

<span class="c1">#</span>
<span class="c1"># TLS certificats</span>
<span class="c1">#</span>
<span class="k">[resolvers.resolvers.ssl]</span>
<span class="c1">#</span>
<span class="c1"># CA file</span>
<span class="c1">#cafile =   	# Optional</span>
<span class="c1">#</span>
<span class="c1"># TLS  certificat</span>
<span class="c1">#</span>
<span class="c1"># Path to the TLS cert file</span>
<span class="c1">#certfile =   	# Optional</span>
<span class="c1">#</span>
<span class="c1"># TLS key file</span>
<span class="c1">#</span>
<span class="c1"># Path to the TLS key file</span>
<span class="c1">#keyfile =   	# Optional</span>
</pre></div>
</div>
</section>
</section>
<section id="case-scenarios">
<h1>Case scenarios<a class="headerlink" href="#case-scenarios" title="Link to this heading"></a></h1>
<section id="synchronizing-pool-cache">
<span id="admin-cache-sync"></span><h2>Synchronizing pool cache<a class="headerlink" href="#synchronizing-pool-cache" title="Link to this heading"></a></h2>
<p>In pool of Qgis services, cache may be desynchronized for different reasons:</p>
<ul class="simple">
<li><p>Scaling up the pool</p></li>
<li><p>Using the <cite>load_project_on_request</cite></p></li>
<li><p>Updating container in a orchestrated environment</p></li>
</ul>
<p>The <a class="reference internal" href="rpc_config.html#rpc-cache-restoration"><span class="std std-ref">cache restoration mecanism</span></a> may prevent most
of desynchronization mecanism, it may be required to manually resync caches:</p>
<p>The cli managment tool provide the <cite>sync</cite> command while the REST api provides the
http method:</p>
<dl class="http patch">
<dt class="sig sig-object http" id="patch--v1-pools-Id-cache">
<span class="sig-name descname"><span class="pre">PATCH</span> </span><span class="sig-name descname"><span class="pre">/v1/pools/{Id}/cache</span></span><a class="headerlink" href="#patch--v1-pools-Id-cache" title="Link to this definition"></a></dt>
<dd><p>Synchronize and update cache between all pool instances</p>
</dd></dl>

</section>
<section id="adding-modifying-or-removing-pool-to-managment-service">
<span id="admin-config-reload"></span><h2>Adding, modifying or removing pool to managment service<a class="headerlink" href="#adding-modifying-or-removing-pool-to-managment-service" title="Link to this heading"></a></h2>
<p>If you add or remove resolver’s you will need to reload the configuration.</p>
<p>The REST api provide a method for reloading the configuration:</p>
<blockquote>
<div><dl class="http patch">
<dt class="sig sig-object http" id="patch--v1-config">
<span class="sig-name descname"><span class="pre">PATCH</span> </span><span class="sig-name descname"><span class="pre">/v1/config</span></span><a class="headerlink" href="#patch--v1-config" title="Link to this definition"></a></dt>
<dd></dd></dl>

<p>Reload the configuration and resync all pools.</p>
</div></blockquote>
<p>All pools will be resynced according to the new resolvers</p>
</section>
<section id="resyncing-with-rpc-pools-when-rescaling-rpc-services">
<span id="admin-pools-sync"></span><h2>Resyncing with rpc pools when rescaling rpc services<a class="headerlink" href="#resyncing-with-rpc-pools-when-rescaling-rpc-services" title="Link to this heading"></a></h2>
<p>If you have scaled your rpc services of if some resolvers are handling with dynamic
configuration, your will only need to resync with the resolvers in order to take
the changes into account.</p>
<blockquote>
<div><dl class="http patch">
<dt class="sig sig-object http" id="patch--vi-pools">
<span class="sig-name descname"><span class="pre">PATCH</span> </span><span class="sig-name descname"><span class="pre">/vi/pools</span></span><a class="headerlink" href="#patch--vi-pools" title="Link to this definition"></a></dt>
<dd></dd></dl>

<p>Resync all pools with resolvers.</p>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="server_config.html" class="btn btn-neutral float-left" title="HTTP frontend" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="managment-api.html" class="btn btn-neutral float-right" title="Managment API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, David Marteau - 3liz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>